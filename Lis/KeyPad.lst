C51 COMPILER V9.52.0.0   KEYPAD                                                            08/14/2018 12:13:19 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE KEYPAD
OBJECT MODULE PLACED IN .\Obj\KeyPad.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Application\Source\KeyPad.c LARGE BROWSE INCDIR(.\Application\Header) DE
                    -BUG OBJECTEXTEND PRINT(.\Lis\KeyPad.lst) TABS(2) OBJECT(.\Obj\KeyPad.obj)

line level    source

   1          #include "stc15f2k60s2.h"
   2          #include "KeyPad.h"
   3          #include "PCF85063BTL.h"
   4          #include "LCD_Driver_SPLC780D.h"
   5          //#include "Receiver_Position_Data.h"
   6          
   7          void DisplayLCD(unsigned char BCD);
   8          void WriteData(unsigned char dat);
   9          
  10          void SPI_WriteTime(unsigned char val,unsigned char addr);
  11          void Command(unsigned char dat);
  12          void LCD_clear(void);
  13          bit move=0;
  14          bit small_move=0;
  15          bit direction=0;
  16          void Delay_ms(unsigned int ms)
  17          {
  18   1        unsigned int De_Cnt;
  19   1        while( (ms--) != 0)
  20   1        {
  21   2          for(De_Cnt = 0; De_Cnt < 600; De_Cnt++); 
  22   2        }             
  23   1      }
  24          unsigned char Key_Scan(void)
  25          {
  26   1        unsigned char KeyTemp1,KeyTemp2;
  27   1        unsigned char KeyValue;
  28   1      
  29   1        //
  30   1        KEYPORT &=(~((1<<Column1)|(1<<Column2)|(1<<Column3)|(1<<Column4))); // ~(00000010 | 00000100 | 00001000)=
             -1111*000*1: set three columns equal to Zero
  31   1        //
  32   1        //0010 0000
  33   1        KEYPORT |= (1<<Line1) | (1<<Line2) | (1<<Line3) | (1<<Line4) ;  //10000000 | 01000000 | 00100000=*111*000
             -00: Set three columns equal to 1
  34   1        //    
  35   1        KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));  //~(10000000 | 01000000 | 00100000)=
             -00011111
  36   1        if(KeyTemp1!=0xff)      //
  37   1        { 
  38   2          Delay_ms(10);         //
  39   2          KeyTemp1=KEYPORT | ( ~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)) );  //~(10000000 | 01000000 | 0010000
             -0)=00011111
  40   2          if(KeyTemp1!=0xff)      //
  41   2          {
  42   3            //COL1 COL2 COL3
  43   3            //0     1     1
  44   3            KEYPORT &=(~(1<<Column1)); //0 1 1 1
  45   3            KEYPORT |= (1<<Column2)|(1<<Column3)|(1<<Column4);//
  46   3            KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));//  KEYPORT | 00011111
  47   3            if(KeyTemp1!=0xff)      //
  48   3            {
  49   4              while(KeyTemp1!=0xff) // if pressed any key on COL1
  50   4              { 
C51 COMPILER V9.52.0.0   KEYPAD                                                            08/14/2018 12:13:19 PAGE 2   

  51   5                KeyTemp2=KeyTemp1;  
  52   5                KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));  // read the data, KEYPORT is the
             - instantaneous value of the PORT.
  53   5              }
  54   4              // run when unpress
  55   4              switch(KeyTemp2)
  56   4              {
  57   5                case ~(1<<Line1):     //S6°
  58   5                {
  59   6                  KeyValue=KEY1;
  60   6                
  61   6                }break;
  62   5                case ~(1<<Line2):     //S9°
  63   5                {
  64   6                  KeyValue=KEY4;
  65   6                
  66   6                }break;
  67   5                case ~(1<<Line3):     //S9°
  68   5                {
  69   6                  KeyValue=KEY7;
  70   6                
  71   6                }break; 
  72   5                case ~(1<<Line4):     //
  73   5                {
  74   6                  KeyValue=KEY_Star;
  75   6                
  76   6                }break;         
  77   5              }
  78   4            }   
  79   3            //COL1 COL2 COL3
  80   3            //1     0     1
  81   3            KEYPORT &=(~(1<<Column2)); 
  82   3            KEYPORT |= (1<<Column1)|(1<<Column3)|(1<<Column4);
  83   3            KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));      //
  84   3            if(KeyTemp1!=0xff)      //
  85   3            {
  86   4              while(KeyTemp1!=0xff) //
  87   4              { 
  88   5                KeyTemp2=KeyTemp1;  
  89   5                KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4))); //
  90   5              }
  91   4              switch(KeyTemp2)
  92   4              {
  93   5                case ~(1<<Line1):     //
  94   5                {
  95   6                  KeyValue=KEY2;
  96   6                
  97   6                }break;
  98   5                case ~(1<<Line2):     //
  99   5                {
 100   6                  KeyValue=KEY5;
 101   6                
 102   6                }break;
 103   5                case ~(1<<Line3):     //
 104   5                {
 105   6                  KeyValue=KEY8;
 106   6                
 107   6                }break;   
 108   5                case ~(1<<Line4):     //
 109   5                {
 110   6                  KeyValue=KEY0;
 111   6                
C51 COMPILER V9.52.0.0   KEYPAD                                                            08/14/2018 12:13:19 PAGE 3   

 112   6                }break;           
 113   5              }
 114   4            }
 115   3            //COL1 COL2 COL3
 116   3            //1     1     0
 117   3            KEYPORT &=(~(1<<Column3)); //1 1 0
 118   3            KEYPORT |= (1<<Column1)|(1<<Column2)|(1<<Column4);
 119   3            KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));     //
 120   3            if(KeyTemp1!=0xff)      //
 121   3            {
 122   4              while(KeyTemp1!=0xff) // if pressed any key of COL3
 123   4              { 
 124   5                KeyTemp2=KeyTemp1;  
 125   5                KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));//
 126   5              }
 127   4              switch(KeyTemp2)
 128   4              {
 129   5                case ~(1<<Line1):     //S8°
 130   5                {
 131   6                  KeyValue=KEY3;
 132   6                
 133   6                }break;
 134   5                case ~(1<<Line2):     //S11°
 135   5                {
 136   6                  KeyValue=KEY6;
 137   6                
 138   6                }break;
 139   5                case ~(1<<Line3):     //S11°
 140   5                {
 141   6                  KeyValue=KEY9;
 142   6                
 143   6                }break;   
 144   5                case ~(1<<Line4):     //
 145   5                {
 146   6                  KeyValue=KEY_SHARP;
 147   6                
 148   6                }break;         
 149   5              }
 150   4            } 
 151   3      
 152   3            //COL1 COL2 COL3 COL4
 153   3            //1     1     1   0
 154   3            KEYPORT &=(~(1<<Column4)); //1 1 1 0
 155   3            KEYPORT |= (1<<Column1)|(1<<Column2)|(1<<Column3);
 156   3            KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));     //
 157   3            if(KeyTemp1!=0xff)      //
 158   3            {
 159   4              while(KeyTemp1!=0xff) // if pressed any key of COL3
 160   4              { 
 161   5                KeyTemp2=KeyTemp1;  
 162   5                KeyTemp1=KEYPORT | (~((1<<Line1)|(1<<Line2)|(1<<Line3)|(1<<Line4)));//
 163   5              }
 164   4              switch(KeyTemp2)
 165   4              {
 166   5                case ~(1<<Line1):     //S8°
 167   5                {
 168   6                  KeyValue=KEY_A;
 169   6                
 170   6                }break;
 171   5                case ~(1<<Line2):     //S11°
 172   5                {
 173   6                  KeyValue=KEY_B;
C51 COMPILER V9.52.0.0   KEYPAD                                                            08/14/2018 12:13:19 PAGE 4   

 174   6                
 175   6                }break;
 176   5                case ~(1<<Line3):     //S11°
 177   5                {
 178   6                  KeyValue=KEY_C;
 179   6                
 180   6                }break;   
 181   5                case ~(1<<Line4):     //
 182   5                {
 183   6                  KeyValue=KEY_D;
 184   6                
 185   6                }break;         
 186   5              }
 187   4            } 
 188   3            
 189   3            return  KeyValue; 
 190   3          }             
 191   2          else
 192   2          {
 193   3            return Unpress;       
 194   3          }
 195   2        }
 196   1        else
 197   1        {
 198   2          return Unpress; 
 199   2        }     
 200   1      }
 201          void Key_Process(void)//
 202          {
 203   1        static int KeyCount=0;
 204   1        static unsigned char KeyNum_Old,KeyNum,PressedKey[5]="hhmms";
 205   1        int d,hours,mins,months,days;
 206   1        KeyNum_Old=KeyNum;
 207   1        KeyNum=Key_Scan();
 208   1        //if( (KeyNum=Key_Scan())!=0 )    //
 209   1        if (KeyNum_Old==Unpress && KeyNum==KEY_C)
 210   1        {
 211   2          if(direction)
 212   2            direction=0;
 213   2          else 
 214   2            direction=1;
 215   2          return;
 216   2        }
 217   1        if (KeyNum==KEY_D && !move)
 218   1        {
 219   2          move =1;
 220   2          return;
 221   2        } 
 222   1        if (KeyNum==KEY_D && move)
 223   1        {
 224   2          move =0;
 225   2          return;
 226   2        }
 227   1        if (KeyNum==KEY_A && auto_mode)
 228   1        {
 229   2          auto_mode=0;
 230   2          return;
 231   2        } 
 232   1        if (KeyNum==KEY_A && !auto_mode)
 233   1        {
 234   2          auto_mode=1;
 235   2          return;
C51 COMPILER V9.52.0.0   KEYPAD                                                            08/14/2018 12:13:19 PAGE 5   

 236   2        }   
 237   1        
 238   1        if (KeyNum==KEY_B)
 239   1        {
 240   2          small_move =1;
 241   2          return;
 242   2        } 
 243   1        
 244   1        if(KeyNum_Old==Unpress && KeyNum!=Unpress)
 245   1        {
 246   2          PressedKey[KeyCount]=KeyNum;
 247   2          KeyCount++;
 248   2          if(KeyCount==5)
 249   2          {
 250   3            //PressedKey[]="";
 251   3            KeyCount=0;
 252   3            //=========================================================================     
 253   3            // Set Hour,Minute
 254   3            //=========================================================================
 255   3            hours=PressedKey[0]*10+PressedKey[1];
 256   3            mins=PressedKey[2]*10+PressedKey[3];
 257   3            if(PressedKey[4]==KEY_SHARP && hours<=24 && mins<=59)// set hour, minute
 258   3            { 
 259   4              SPI_WriteTime((PressedKey[0]<<4)|PressedKey[1],Hours);//Write BCD value
 260   4              SPI_WriteTime((PressedKey[2]<<4)|PressedKey[3],Minutes);//Write BCD value
 261   4            }
 262   3            //=========================================================================     
 263   3            // Set Month,Day      
 264   3            //=========================================================================
 265   3            months=PressedKey[0]*10+PressedKey[1];
 266   3            days=PressedKey[2]*10+PressedKey[3];      
 267   3            if (PressedKey[4]==KEY_Star && months<=12 )//Set month and day
 268   3            {
 269   4              if(months<=7)//1..7
 270   4              {
 271   5                if(months%2)//month has 31 days,1 3 5 7 
 272   5                {
 273   6                  if(days<=31)
 274   6                  {
 275   7                    SPI_WriteTime((PressedKey[0]<<4)|PressedKey[1],Months);//Write BCD value
 276   7                    SPI_WriteTime((PressedKey[2]<<4)|PressedKey[3],Days);//Write BCD value              
 277   7                  }
 278   6                }
 279   5                else //2 4 6 
 280   5                {
 281   6                  if (months==2)//February
 282   6                  {
 283   7                    if(days<=28)
 284   7                    {
 285   8                      SPI_WriteTime((PressedKey[0]<<4)|PressedKey[1],Months);//Write BCD value
 286   8                      SPI_WriteTime((PressedKey[2]<<4)|PressedKey[3],Days);//Write BCD value              
 287   8                    }             
 288   7                    
 289   7                  }
 290   6                  else //4 6 
 291   6                  {
 292   7                    if(days<=30)
 293   7                    {
 294   8                      SPI_WriteTime((PressedKey[0]<<4)|PressedKey[1],Months);//Write BCD value
 295   8                      SPI_WriteTime((PressedKey[2]<<4)|PressedKey[3],Days);//Write BCD value              
 296   8                    }                 
 297   7                    
C51 COMPILER V9.52.0.0   KEYPAD                                                            08/14/2018 12:13:19 PAGE 6   

 298   7                  }
 299   6                      
 300   6                }
 301   5              }
 302   4              else  //8..12
 303   4              {
 304   5                if(!(months%2))//month has 31 days,8 10 12
 305   5                {
 306   6                  if(days<=31)
 307   6                  {
 308   7                    SPI_WriteTime((PressedKey[0]<<4)|PressedKey[1],Months);//Write BCD value
 309   7                    SPI_WriteTime((PressedKey[2]<<4)|PressedKey[3],Days);//Write BCD value              
 310   7                  }
 311   6                }
 312   5                else //9 11
 313   5                {
 314   6                    if(days<=30)
 315   6                    {
 316   7                      SPI_WriteTime((PressedKey[0]<<4)|PressedKey[1],Months);//Write BCD value
 317   7                      SPI_WriteTime((PressedKey[2]<<4)|PressedKey[3],Days);//Write BCD value              
 318   7                    }                 
 319   6                }
 320   5              }
 321   4            }   
 322   3            LCD_clear();
 323   3            Command(0x08);
 324   3            Command(0x00);      
 325   3            WriteData(0x68);//display "h"
 326   3            WriteData(0x68);//display "h"
 327   3            WriteData(0x6D);//display "m"
 328   3            WriteData(0x6D);//display "m"
 329   3            WriteData(0x23);//display "#" SETTIME_KEY     
 330   3          }
 331   2          //LCD Display the pressed buttons
 332   2        for(d=0;d<KeyCount;d++)
 333   2        {
 334   3          if(KeyCount<=4)
 335   3          {
 336   4            Command(0x08);
 337   4            Command(0x00+d);
 338   4            WriteData(PressedKey[d]|0x30);
 339   4          }
 340   3        } 
 341   2      
 342   2        }
 343   1        
 344   1      
 345   1        
 346   1      }
 347          /***********************************************
 348          ************************************************/
 349          void KeyPad_IO_Init(void)
 350          { 
 351   1        P0M1 &=~( (1<<1) | (1<<2) | (1<<3) | (1<<4) | (1<<5) | (1<<6) | (1<<7) );  
 352   1        P0M0 &=~( (1<<1) | (1<<2) | (1<<3) | (1<<4) | (1<<5) | (1<<6) | (1<<7) );    
 353   1      }
 354          
 355          
 356          
 357          
 358          
 359          
C51 COMPILER V9.52.0.0   KEYPAD                                                            08/14/2018 12:13:19 PAGE 7   

 360          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1094    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      9       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
